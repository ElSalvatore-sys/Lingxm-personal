<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">

    <!-- Aggressive Cache Control -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>LingXM Personal - Daily Words</title>

    <!-- PWA Configuration -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
    <meta name="theme-color" content="#667eea">

    <!-- iOS-specific meta tags -->
    <meta name="apple-mobile-web-app-title" content="LingXM">
    <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/icons/icon-192x192.png">

    <!-- Bootstrap Version Check (RUNS FIRST - Before Service Worker) -->
    <script>
      (async function() {
        try {
          // Fetch version.json with no caching
          const response = await fetch('/version.json', {
            cache: 'no-store',
            headers: { 'Cache-Control': 'no-cache, no-store, must-revalidate' }
          });

          if (response.ok) {
            const serverVersion = await response.json();
            const cachedTimestamp = localStorage.getItem('lingxm-build-timestamp');

            console.log('[Bootstrap] Server build:', serverVersion.timestamp);
            console.log('[Bootstrap] Cached build:', cachedTimestamp || 'none');

            // If we have a cached version and server version is newer
            if (cachedTimestamp && serverVersion.timestamp > parseInt(cachedTimestamp)) {
              console.log('[Bootstrap] ‚ö†Ô∏è STALE BUILD DETECTED! Clearing cache and reloading...');

              // Unregister all service workers
              if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const reg of registrations) {
                  await reg.unregister();
                  console.log('[Bootstrap] Unregistered service worker');
                }
              }

              // Clear all caches
              if ('caches' in window) {
                const cacheNames = await caches.keys();
                for (const name of cacheNames) {
                  await caches.delete(name);
                  console.log('[Bootstrap] Deleted cache:', name);
                }
              }

              // Update cached timestamp
              localStorage.setItem('lingxm-build-timestamp', serverVersion.timestamp.toString());

              // Force reload
              console.log('[Bootstrap] Reloading page...');
              window.location.reload();

              // Prevent further script execution
              return;
            }

            // Update cached timestamp
            localStorage.setItem('lingxm-build-timestamp', serverVersion.timestamp.toString());
            console.log('[Bootstrap] ‚úÖ Build is up to date');
          }
        } catch (error) {
          console.warn('[Bootstrap] Failed to check version:', error);
          // Continue anyway - don't block the app
        }
      })();
    </script>

    <!-- Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js?nocache=' + Date.now(), {
            updateViaCache: 'none'  // Critical: bypasses HTTP cache for SW updates
          })
            .then(reg => {
              console.log('[PWA] Service Worker registered:', reg.scope);

              // Check for updates every time the page loads
              reg.update();

              // Listen for updates
              reg.addEventListener('updatefound', () => {
                const newWorker = reg.installing;
                console.log('[PWA] New service worker found, installing...');

                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // New service worker installed, auto-reload to activate
                    console.log('[PWA] New version available! Reloading...');
                    window.location.reload();
                  }
                });
              });

              // Listen for controller change (when SW activates)
              navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('[PWA] Controller changed, reloading...');
                window.location.reload();
              });
            })
            .catch(err => console.error('[PWA] Service Worker registration failed:', err));
        });
      }
    </script>

    <link rel="stylesheet" href="./src/styles/main.css?v=5.0">

    <!-- AGGRESSIVE CACHE BUSTING - iPhone & all browsers -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-control" content="no-cache, no-store, must-revalidate">
    
    <!-- Build Version (injected at build time) -->
    <meta name="build-timestamp" content="0">
    <meta name="build-version" content="dev">
    
    <!-- Version Check Script - LOADS BEFORE SERVICE WORKER -->
    <script>
      // Aggressive version check on every page load
      (function() {
        console.log('[Bootstrap] Version check running...');
        
        // Get current build timestamp from HTML
        const htmlTimestamp = parseInt(document.querySelector('meta[name="build-timestamp"]')?.getAttribute('content') || '0', 10);
        console.log('[Bootstrap] Current build timestamp:', htmlTimestamp);
        
        // Check for version.json immediately
        fetch('/version.json?nocache=' + Date.now(), {
          cache: 'no-store',
          headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache'
          }
        })
          .then(r => r.json())
          .then(data => {
            console.log('[Bootstrap] Latest version:', data.timestamp);
            
            // If newer version exists, unregister SW and reload
            if (data.timestamp > htmlTimestamp) {
              console.error('[Bootstrap] STALE BUILD DETECTED! Current:', htmlTimestamp, 'Latest:', data.timestamp);
              console.log('[Bootstrap] Unregistering service workers...');
              
              if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(regs => {
                  regs.forEach(reg => {
                    console.log('[Bootstrap] Unregistering:', reg.scope);
                    reg.unregister();
                  });
                });
              }
              
              // Clear all caches
              if ('caches' in window) {
                caches.keys().then(names => {
                  names.forEach(name => {
                    console.log('[Bootstrap] Clearing cache:', name);
                    caches.delete(name);
                  });
                });
              }
              
              // Force reload after brief delay
              setTimeout(() => {
                console.log('[Bootstrap] FORCING HARD RELOAD');
                window.location.href = window.location.href;
              }, 500);
            }
          })
          .catch(e => {
            console.warn('[Bootstrap] Could not check version:', e.message);
            // Continue anyway - version check module will handle it
          });
      })();
    </script></head>
<body>
    <div id="app">
        <!-- Welcome Screen (First-Time Only) -->
        <div id="welcome-screen" class="screen">
            <div class="welcome-container">
                <div class="welcome-slides">
                    <!-- Slide 1: Welcome -->
                    <div class="welcome-slide active" data-slide="0">
                        <div class="welcome-content">
                            <div class="welcome-icon">üéì</div>
                            <h1 class="welcome-title">Welcome to LingXM</h1>
                            <p class="welcome-subtitle">Your personal language learning companion</p>
                            <p class="welcome-description">
                                Learn at your own pace with smart vocabulary tracking,
                                achievement badges, and personalized progress insights.
                            </p>
                        </div>
                    </div>

                    <!-- Slide 2: How to Use -->
                    <div class="welcome-slide" data-slide="1">
                        <div class="welcome-content">
                            <div class="welcome-icon">üëÜ</div>
                            <h1 class="welcome-title">How to Use</h1>
                            <ul class="welcome-features">
                                <li><strong>Swipe left/right</strong> to navigate between words</li>
                                <li><strong>Tap üîä</strong> to hear pronunciation</li>
                                <li><strong>Save words</strong> with ‚≠ê for later review</li>
                                <li><strong>Track progress</strong> with üèÜ achievements</li>
                                <li><strong>Practice daily</strong> to build your streak üî•</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Slide 3: Security -->
                    <div class="welcome-slide" data-slide="2">
                        <div class="welcome-content">
                            <div class="welcome-icon">üîê</div>
                            <h1 class="welcome-title">Secure Your Profile</h1>
                            <p class="welcome-description">
                                Set a 4-digit PIN to protect your learning progress
                                and keep your data private.
                            </p>
                            <p class="welcome-description" style="opacity: 0.7; font-size: 0.9rem;">
                                You can skip this and add it later in settings.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="welcome-nav">
                    <button id="welcome-back-btn" class="welcome-btn welcome-btn-secondary" style="display: none;">
                        ‚Üê Back
                    </button>
                    <button id="welcome-next-btn" class="welcome-btn welcome-btn-primary">
                        Next ‚Üí
                    </button>
                    <button id="welcome-get-started-btn" class="welcome-btn welcome-btn-primary" style="display: none;">
                        Get Started!
                    </button>
                </div>

                <!-- Indicators -->
                <div class="welcome-indicators">
                    <div class="welcome-dot active" data-slide="0"></div>
                    <div class="welcome-dot" data-slide="1"></div>
                    <div class="welcome-dot" data-slide="2"></div>
                </div>

                <!-- Skip -->
                <button id="welcome-skip-btn" class="welcome-skip">Skip ‚Üí</button>
            </div>
        </div>

        <!-- Profile Selection Screen -->
        <div id="profile-selection" class="screen active">
            <div class="profile-scroll-wrapper">
                <div class="profile-container">
                    <h1 class="app-title">LingXM Personal</h1>
                    <div class="profile-buttons">
                    <button class="profile-btn" data-profile="vahiko">
                        <div class="profile-progress-rings"></div>
                        <span class="profile-emoji">üë©‚Äçüíº</span>
                        <span class="profile-name">Vahiko</span>
                        <div class="profile-streak"></div>
                    </button>
                    <button class="profile-btn" data-profile="hassan">
                        <div class="profile-progress-rings"></div>
                        <span class="profile-emoji">üë®‚Äçüíª</span>
                        <span class="profile-name">Hassan</span>
                        <div class="profile-streak"></div>
                    </button>
                    <button class="profile-btn" data-profile="salman">
                        <div class="profile-progress-rings"></div>
                        <span class="profile-emoji">üë©‚Äçüç≥</span>
                        <span class="profile-name">Frau Salman</span>
                        <div class="profile-streak"></div>
                    </button>
                    <button class="profile-btn" data-profile="kafel">
                        <div class="profile-progress-rings"></div>
                        <span class="profile-emoji">üë®‚Äçüíª</span>
                        <span class="profile-name">Kafel</span>
                        <div class="profile-streak"></div>
                    </button>
                    <button class="profile-btn" data-profile="jawad">
                        <div class="profile-progress-rings"></div>
                        <span class="profile-emoji">üë®‚Äçüç≥</span>
                        <span class="profile-name">Jawad</span>
                        <div class="profile-streak"></div>
                    </button>
                    <button class="profile-btn" data-profile="ameeno">
                        <div class="profile-progress-rings"></div>
                        <span class="profile-emoji">üßë‚Äçüéì</span>
                        <span class="profile-name">Ameeno</span>
                        <div class="profile-streak"></div>
                    </button>
                </div>
                </div>
            </div>
        </div>

        <!-- Learning Screen -->
        <div id="learning-screen" class="screen">
            <div class="header">
                <button id="back-btn" class="icon-btn">‚Üê</button>
                <div class="progress-info">
                    <span id="current-lang">Deutsch</span>
                </div>
                <div class="header-actions">
                    <button id="achievements-btn" class="icon-btn">
                        üèÜ
                        <span class="notification-badge" id="achievement-badge" style="display:none;"></span>
                    </button>
                    <button id="settings-btn" class="icon-btn">‚öôÔ∏è</button>
                    <button id="save-word-btn" class="icon-btn">‚≠ê</button>
                </div>
            </div>

            <div class="word-card" id="word-card">
                <div class="swipe-hint">‚Üê Previous | Next ‚Üí</div>
                
                <div class="word-main">
                    <div class="mastery-indicator" id="mastery-indicator">
                        <div class="mastery-stars" id="mastery-stars">
                            <span class="star">‚≠ê</span>
                            <span class="star">‚≠ê</span>
                            <span class="star">‚≠ê</span>
                            <span class="star">‚≠ê</span>
                            <span class="star">‚≠ê</span>
                        </div>
                        <span class="mastery-label" id="mastery-label">New</span>
                    </div>
                    <h2 id="word-text" class="word-text">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</h2>
                    <p id="word-translation" class="word-translation"></p>
                </div>

                <div class="word-details">
                    <div class="section">
                        <h3 id="explanation-header">ÿ¥ÿ±ÿ≠ / Erkl√§rung</h3>
                        <p id="word-explanation"></p>
                    </div>

                    <div class="section" id="conjugation-section">
                        <h3 id="conjugation-header">ÿ™ÿµÿ±ŸäŸÅ / Konjugation</h3>
                        <div id="word-conjugations"></div>
                    </div>

                    <div class="section">
                        <h3 id="example1-header">ŸÖÿ´ÿßŸÑ Ÿ° / Beispiel 1</h3>
                        <p id="example-1"></p>
                    </div>

                    <div class="section">
                        <h3 id="example2-header">ŸÖÿ´ÿßŸÑ Ÿ¢ / Beispiel 2</h3>
                        <p id="example-2"></p>
                    </div>
                </div>
            </div>

            <div class="language-switcher">
                <button class="lang-btn" data-lang="0">Lang 1</button>
                <button class="lang-btn" data-lang="1">Lang 2</button>
                <button class="lang-btn" data-lang="2">Lang 3</button>
                <button class="lang-btn" data-lang="3">Lang 4</button>
            </div>

            <!-- Settings Modal -->
            <div id="settings-modal" class="settings-modal">
                <div class="settings-content">
                    <div class="settings-header">
                        <h2>‚öôÔ∏è Settings / Einstellungen</h2>
                        <button id="close-settings" class="icon-btn">‚úï</button>
                    </div>

                    <div class="settings-section">
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>üåì Theme / Motiv</span>
                                <p class="setting-description">Switch between dark and light mode</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="theme-toggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="setting-item">
                            <div class="setting-label">
                                <span>Auto-Play / Automatisch</span>
                                <p class="setting-description">Play word pronunciation automatically</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoplay-toggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="setting-item" id="pin-setting-item" style="display:none;">
                            <div class="setting-label">
                                <span>üîê PIN Security / PIN-Sicherheit</span>
                                <p class="setting-description">Protect your profile with a 4-digit PIN</p>
                            </div>
                            <button id="change-pin-btn" class="setting-action-btn">
                                Change PIN
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Swipe Tutorial Overlay (First-Time Per Profile) -->
            <div id="swipe-tutorial" class="swipe-tutorial">
                <div class="swipe-tutorial-content">
                    <div class="swipe-tutorial-header">
                        <h2>üëÜ Quick Tutorial</h2>
                    </div>

                    <div class="swipe-tutorial-body">
                        <div class="swipe-gesture-demo">
                            <div class="swipe-arrow swipe-left">
                                <span class="arrow-icon">üëà</span>
                                <span class="arrow-label">Swipe left<br>for next word</span>
                            </div>
                            <div class="swipe-arrow swipe-right">
                                <span class="arrow-icon">üëâ</span>
                                <span class="arrow-label">Swipe right<br>for previous</span>
                            </div>
                        </div>

                        <div class="swipe-tutorial-tips">
                            <p><strong>Tip:</strong> Tap üîä to hear pronunciation</p>
                            <p><strong>Tip:</strong> Save words with ‚≠ê for later</p>
                        </div>
                    </div>

                    <button id="swipe-tutorial-dismiss" class="swipe-tutorial-btn">
                        Got it!
                    </button>
                </div>
            </div>

            <!-- Achievements Modal -->
            <div id="achievements-modal" class="achievements-modal">
                <div class="achievements-content">
                    <div class="achievements-header">
                        <h2>üèÜ Achievements</h2>
                        <button id="close-achievements" class="icon-btn">‚úï</button>
                    </div>

                    <!-- Progress to Next Badge -->
                    <div class="next-badge-progress">
                        <div class="next-badge-info">
                            <span class="next-badge-icon">üéØ</span>
                            <div class="next-badge-text">
                                <p class="next-badge-title">Next Badge</p>
                                <p class="next-badge-name">Beginner</p>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: 0%;"></div>
                            <span class="progress-bar-text">0 / 10</span>
                        </div>
                    </div>

                    <!-- Achievements Grid -->
                    <div class="achievements-grid">
                        <!-- Word Milestones -->
                        <div class="achievement-category">
                            <h3 class="category-title">üìö Word Milestones</h3>
                            <div class="badges-grid" id="word-badges-grid">
                                <!-- Badges will be inserted here via JS -->
                            </div>
                        </div>

                        <!-- Streak Milestones -->
                        <div class="achievement-category">
                            <h3 class="category-title">üî• Streak Milestones</h3>
                            <div class="badges-grid" id="streak-badges-grid">
                                <!-- Badges will be inserted here via JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PIN Authentication Modal -->
        <div id="pin-modal" class="pin-modal">
            <div class="pin-content">
                <div class="pin-profile-header">
                    <span id="pin-profile-emoji" class="pin-profile-emoji"></span>
                    <h2 id="pin-modal-title">üîí Enter PIN</h2>
                    <p id="pin-profile-name" class="pin-profile-name"></p>
                </div>

                <div class="pin-dots">
                    <div class="pin-dot"></div>
                    <div class="pin-dot"></div>
                    <div class="pin-dot"></div>
                    <div class="pin-dot"></div>
                </div>

                <p id="pin-message" class="pin-message"></p>

                <div class="pin-keypad">
                    <button class="pin-key" data-digit="1">1</button>
                    <button class="pin-key" data-digit="2">2</button>
                    <button class="pin-key" data-digit="3">3</button>
                    <button class="pin-key" data-digit="4">4</button>
                    <button class="pin-key" data-digit="5">5</button>
                    <button class="pin-key" data-digit="6">6</button>
                    <button class="pin-key" data-digit="7">7</button>
                    <button class="pin-key" data-digit="8">8</button>
                    <button class="pin-key" data-digit="9">9</button>
                    <button class="pin-key pin-key-backspace" aria-label="Delete">‚Üê</button>
                    <button class="pin-key" data-digit="0">0</button>
                    <button class="pin-key pin-key-submit" aria-label="Submit">‚úì</button>
                </div>

                <div class="pin-actions">
                    <button id="pin-cancel-btn" class="pin-btn-secondary">Cancel</button>
                    <button id="pin-forgot-btn" class="pin-btn-link" style="display:none;">Forgot PIN?</button>
                </div>
            </div>
        </div>

        <!-- First-Time PIN Setup Modal -->
        <div id="pin-setup-modal" class="pin-modal">
            <div class="pin-content pin-setup-content">
                <div class="pin-setup-header">
                    <span id="pin-setup-emoji" class="pin-profile-emoji"></span>
                    <h2>üîê Protect Your Profile</h2>
                    <p id="pin-setup-name" class="pin-setup-profile-name"></p>
                    <p class="pin-setup-description">Would you like to protect this profile with a 4-digit PIN?</p>
                </div>

                <div class="pin-setup-actions">
                    <button id="pin-setup-skip-btn" class="pin-btn-secondary">Skip for Now</button>
                    <button id="pin-setup-create-btn" class="pin-btn-primary">Create PIN</button>
                </div>
            </div>
        </div>

        <!-- Analytics Stats Modal (Admin View) -->
        <div id="analytics-modal" class="analytics-modal">
            <div class="analytics-content">
                <div class="analytics-header">
                    <h2>üìä Usage Statistics</h2>
                    <button id="close-analytics" class="icon-btn">‚úï</button>
                </div>

                <div class="analytics-body">
                    <!-- Summary Stats -->
                    <div class="analytics-section">
                        <h3>Summary</h3>
                        <div class="analytics-stats-grid">
                            <div class="analytics-stat">
                                <span class="stat-value" id="stat-total-sessions">0</span>
                                <span class="stat-label">Total Sessions</span>
                            </div>
                            <div class="analytics-stat">
                                <span class="stat-value" id="stat-total-words">0</span>
                                <span class="stat-label">Total Words</span>
                            </div>
                            <div class="analytics-stat">
                                <span class="stat-value" id="stat-avg-session">0 min</span>
                                <span class="stat-label">Avg Session</span>
                            </div>
                            <div class="analytics-stat">
                                <span class="stat-value" id="stat-total-events">0</span>
                                <span class="stat-label">Total Events</span>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Usage -->
                    <div class="analytics-section">
                        <h3>Most Used Profiles</h3>
                        <div id="analytics-profiles" class="analytics-list">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>

                    <!-- Features -->
                    <div class="analytics-section">
                        <h3>Feature Usage</h3>
                        <div class="analytics-stats-grid">
                            <div class="analytics-stat">
                                <span class="stat-value" id="stat-achievements">0</span>
                                <span class="stat-label">Achievements</span>
                            </div>
                            <div class="analytics-stat">
                                <span class="stat-value" id="stat-saved-words">0</span>
                                <span class="stat-label">Saved Words</span>
                            </div>
                            <div class="analytics-stat">
                                <span class="stat-value" id="stat-avg-streak">0</span>
                                <span class="stat-label">Avg Streak</span>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="analytics-section">
                        <h3>Recent Sessions</h3>
                        <div id="analytics-recent" class="analytics-recent-list">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="analytics-actions">
                        <button id="analytics-export-btn" class="analytics-btn analytics-btn-secondary">
                            Export Data
                        </button>
                        <button id="analytics-clear-btn" class="analytics-btn analytics-btn-danger">
                            Clear All Data
                        </button>
                    </div>

                    <!-- Privacy Notice -->
                    <div class="analytics-privacy-notice">
                        <p>üîí All data is stored locally on your device. No external tracking.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="./src/app.js?v=5.0"></script>
</body>
</html>
